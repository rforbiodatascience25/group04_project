---
title: "lab06_exercises"
format:
  html:
    embed-resources: true
editor: visual
---

## Load libraries

```{r}
library(tidyverse)
library(modelr)
library(splines)
library(readr)
library(dplyr)
library(purrr)
library(broom)
library(forcats)
library(ggrepel)
library(hgu133plus2.db)
library(AnnotationDbi)
library(dplyr)
library(tibble)
```

## Load Data

```{r}
#| eval: true
borovecki_tibble <- readRDS("~/projects/group04_project/data/borovecki_tibble.rds")
```

## Clean Data

To apply funcitonal modeling

```{r}
borovecki_tibble <- borovecki_tibble |>
  pivot_wider(
    id_cols = c(sample, diagnosis),
    names_from = gene,
    values_from = expressionValue
  ) |>
  mutate(
    Diagnosis = case_when(
      diagnosis == "symptomatic" ~ 1,
      diagnosis == "control" ~ 0
    )
  ) |>
  dplyr::select(-diagnosis) |>
  dplyr::select(-sample) |>
  relocate(Diagnosis, .before = 1)
```

## Analysis

**T7: Use the `lm()` function to create your first model and save it to a new variable e.g. “my_first_model”**

```{r}
my_first_model <- lm(
  PMS1 ~ Diagnosis , 
  data = borovecki_tibble)
```

**Q7: What are your coefficients? Mine are**

```{r}
coef(my_first_model)
```

(Intercept) 56.82 // Diagnosis 33.17

**T8: Use the `group_by()summarise()` workflow to calculate the mean values of the gene expression for your favourite gene stratified on `early_metastasis`**

```{r}
borovecki_tibble |>
  group_by(Diagnosis) |>
  summarize(
    mu = mean(PMS1, na.rm = TRUE), # This works
  )
```

**Q9: Discuss in your group: How are your coefficients related to your mean expression values?**

The intercept of the linear model is the mean expression value of PMS1 for patients (0) without hungington disesase. Whereas the mean expression value for patient (1) with hungington disesase is the sum of the intercept plus the slope (It shows how it decreases or increases the mean of expression when there is early metastasis).

**Q10: Discuss in your group: Is your gene up- or down-regulated from `Diagnosis = 0` to `Diagnosis``= 1` and use the `summary()` function to see if is it statistically significant at a level of significance of alfa = 0.05?**

Although this gene expression tends to be UP-regulated in patients type 1 (positive slope) the p-value is 0.00647 \< 0.05 which indicates that the effect is statistically significant at that alfa = 0.05.

```{r}
summary(my_first_model)
```

All the genes, all the models

**Q11: How many genes are there in the gravier data set?**

There are 13041 genes.

**Q12: Discuss in your group, if the** `borovecki_tibble` **is a “wide” or a “long” dataset?**

This is a wide data set because each row is a patient and each column is a gene. Tidy data (long data set) should have a column "gene" that specifies the gene name, another with values (expression) and early metastasis values.

```{r}
borovecki_tibble_long <- borovecki_tibble  |> 
  pivot_longer(
    cols = -Diagnosis, # <--- ¡EXCLUYE LA COLUMNA 'Diagnosis'!
    names_to = "gene",
    values_to = "log2_expr_level"
  ) |>
  mutate(
    log2_expr_level = log2(log2_expr_level)
  )
```

**T10: Create a `dplyr` pipeline, use the `group_by()` function to group your `gravier_clean_aug_long` dataset by `gene` and then add the `nest()` and `ungroup()` functions to your pipeline**

```{r}
borovecki_tibble_long_nested <- borovecki_tibble_long |> 
  group_by(gene) |> 
  nest() |> 
  ungroup()
```

**Q13: Discuss in your group, what happened to the data?**

```{r}
# gravier_clean_aug_long_nested$data[[1]] 

# gravier_clean_aug_long_nested |>
#   filter(gene == "g2E09") |> 
#   pull(data)
```

I have a data fram with different values of early metastasis and log2_expr_level for each gene ID (corresponding to several patients)

**Q14: Moreover, discuss in your group, what does `<tibble [168 × 2]>` mean?**

It's a tibble that has information of 168 patients for 2 variables (early metastasis and expression level) for the same gene

## Fitting models

The goal is to fit a linear model to each gene

**T11: Use the `group_by()` function to let `R` know, that we want to work *per* gene**

```{r}
by_gene <- borovecki_tibble_long_nested |> 
  # The tibble is internally being group by the gene, works for certain functions
  # NEST() need groups
  group_by(gene)

borovecki_tibble_long_nested
by_gene
```

**T12: Then using the `map()`-function, add a new line to your pipeline, where you add a new variable `model_object` to your `gravier_clean_aug_long_nested` dataset, which `R` will compute *per* gene**

```{r}
linear_model <- function(df) {
  lm(
  log2_expr_level ~ Diagnosis , 
  data = df)
}

borovecki_tibble_long_nested  <- borovecki_tibble_long_nested  |>  
  mutate(model_object = map(data, linear_model))

borovecki_tibble_long_nested
```

Let's get information from each of the models

```{r}
borovecki_tibble_long_nested |>
  
  # Here, you should replace "g2E09" with whatever was YOUR favourite gene!
  filter(gene == "MLH1") |> 
  
  # Pull() on tibbles: This pulls out the model_object variable.
  #   Note! This is a list, because we nested!
  pull(model_object) |> 
  
  # Pluck() on lists: From the list we got from the last step,
  #   we "pluck" the first element
  pluck(1) |>
  
  # The result of pluck, is a model object,
  #   upon which we can call the tidy function
  tidy(conf.int = TRUE,
       conf.level = 0.95)
```

**T13: Scroll a bit back to where we created the `model_object` and see if you can translate that into mapping the `tidy()` function to the `model_object` variable, thereby creating a new variable `model_object_tidy` - This is tricky, so do make sure to discuss in your group how this can be done!**

```{r}
tidy_data <- function(df) {
  df |>
  tidy(conf.int = TRUE,
       conf.level = 0.95)
  }

borovecki_tibble_long_nested  <- borovecki_tibble_long_nested  |>  
  mutate(model_object_tidy = map(model_object, tidy_data))

borovecki_tibble_long_nested
```

```{r}
# gravier_clean_aug_long_nested$model_object_tidy[[1]]
# gravier_clean_aug_long_nested |>
#   filter(gene == "g2E09") |> # Replace "g2E09" 
#   pull(model_object_tidy)
```

**T14: Create a `dplyr` pipeline and save the result in a new variable called `gravier_estimates`: Use the `unnest()` function to unpack the `model_object_tidy`**

```{r}
borovecki_estimates <- unnest(borovecki_tibble_long_nested, model_object_tidy)
borovecki_estimates
```

**T15: Then again, create a `dplyr` pipeline and save the result in a the same `gravier_estimates` variable: Subset the rows to only get the slope term and then choose variables as displayed below, finally end with un-grouping your data, as we no longer need the groups**

```{r}
borovecki_estimates <- borovecki_estimates |> 
  filter(term == "Diagnosis")|> 
  dplyr::select(gene, p.value, estimate, conf.low, conf.high) 
```

**T16: To your `gravier_estimates` dataset, add a variable `q.value`, which is the result of calling the `p.adjust()` function on your `p.value` variable and also add an indicator variable denoting if a given gene is significant or not**

```{r}
borovecki_estimates <- borovecki_estimates |> 
  mutate(q.value=p.adjust(p.value),
          is_significant = case_when(
            p.value >= 0.05 ~ "no",
            p.value < 0.05 ~ "yes"
    ))
```

**T17: Re-create this forest plot to finally reveal the results of your analysis**

```{r}
borovecki_estimates |> 
  filter(is_significant == "yes") |> 
  arrange(p.value) |> 
  slice_head(n = 30) |> 
  mutate(
    gene=fct_reorder(gene, estimate)
  ) |> 
  ggplot(aes(x=estimate, y=gene))+
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +   
  geom_point() +
  labs(
    title = "Genes Associated with hungington disease",
    x = "Estimates (95%CIs)",
    y = NULL
  ) +
  theme_minimal() 
```

**T18: Re-create this volcano plot to finally reveal the results of your analysis**

```{r}
borovecki_data <- borovecki_estimates |> 
  mutate(
    significance = case_when(
      q.value < 0.05 ~ "Significant",
      q.value >= 0.05 ~ "Not Significant"
    ),
    lbl = case_when(
      q.value < 0.05 ~ gene,
      q.value >= 0.05 ~ ""
  ))

ggplot(borovecki_data, aes(x = estimate, y = -log10(p.value))) + 
  geom_point(aes(color=significance, label=lbl), alpha=0.5, size=1) +
  geom_text_repel(aes(color=significance, label = lbl), size = 2, max.overlaps = Inf) +
  labs(
    title = "Genes Associated with hungington disease",
    subtitle = "Genes highlighted in turquoise were significant after multiple testing correction",
    x = "Estimates",
    y = "-log10(p)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") 
```
